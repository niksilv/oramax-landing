/**
 * OramaX ML Toggle + Badge (safe, self-contained)
 * Exports: window.updateMlBadge, window.setMlEnabled, window.getMlEnabled
 */
(function () {
  var LS_KEY = "oramax_ml_enabled";
  var state = (function(){
    try { return localStorage.getItem(LS_KEY) === "1"; } catch(e){ return false; }
  })();

  function ensureBadge() {
    var el = document.getElementById("ml-badge");
    if (!el) {
      el = document.createElement("span");
      el.id = "ml-badge";
      el.style.cssText = "display:inline-block;margin-left:8px;padding:2px 8px;border-radius:12px;font:12px/18px system-ui, sans-serif;background:#eee;color:#333;vertical-align:middle;";
      var host = document.querySelector("[data-ml-badge-host]") || document.body;
      host.appendChild(el);
    }
    return el;
  }

  function updateMlBadge() {
    var el = ensureBadge();
    el.textContent = state ? "ML: ON" : "ML: OFF";
    el.style.background = state ? "#c6f6d5" : "#eee";
    el.style.color = state ? "#065f46" : "#333";
  }

  function setMlEnabled(next) {
    state = !!next;
    try { localStorage.setItem(LS_KEY, state ? "1" : "0"); } catch(e){}
    updateMlBadge();
    var ev;
    try { ev = new CustomEvent("oramax:ml-toggle", { detail: { enabled: state } }); }
    catch(e){ ev = document.createEvent("CustomEvent"); ev.initCustomEvent("oramax:ml-toggle", true, true, { enabled: state }); }
    window.dispatchEvent(ev);
  }

  function getMlEnabled() { return !!state; }

  // Expose APIs
  window.updateMlBadge = updateMlBadge;
  window.setMlEnabled = setMlEnabled;
  window.getMlEnabled = getMlEnabled;

  // Wire UI controls if exist (checkbox or button)
  function wireControls() {
    var cb = document.querySelector("#ml-toggle, [data-ml-toggle]");
    if (cb) {
      var isCheckbox = (cb.type === "checkbox");
      if (isCheckbox) cb.checked = state;
      cb.addEventListener("click", function(){
        setMlEnabled(isCheckbox ? cb.checked : !state);
      });
    }
    updateMlBadge();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", wireControls);
  } else {
    wireControls();
  }
})();
